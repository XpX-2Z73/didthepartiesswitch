name: Verify Primary Sources

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger
  push:
    paths:
      - 'scripts/verify-sources.js'
      - 'src/_data/sourceVerification.json'

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run source verification
        id: verify
        continue-on-error: true
        run: node scripts/verify-sources.js

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet src/_data/sourceVerification.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit verification results
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/_data/sourceVerification.json
          git commit -m "Update source verification results

          Automated verification run: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
          git push

      - name: Create tampering alert issue
        if: steps.verify.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('src/_data/sourceVerification.json', 'utf8'));

            if (data.warnings && data.warnings.length > 0) {
              const warningsList = data.warnings.map(w =>
                `### ${w.sourceName}\n\n` +
                `**Warning:** ${w.warning}\n\n` +
                `- Live URL: ${w.liveUrl}\n` +
                `- Archive URL: ${w.archiveUrl}\n` +
                `- Detected: ${w.detectedAt}`
              ).join('\n\n---\n\n');

              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'source-tampering'
              });

              if (existingIssues.data.length === 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'âš ï¸ Primary Source Tampering Detected',
                  body: `# Primary Source Verification Alert

            The automated source verification has detected that one or more primary source documents have been modified from their archived versions.

            ## Affected Sources

            ${warningsList}

            ## What This Means

            The live versions of these documents no longer contain the quotes that were present in the archived versions from 2023. This could indicate:

            1. **Content removal or modification** - The source may have been edited
            2. **Website restructuring** - The content may have moved to a different URL
            3. **Technical issues** - The verification may have failed due to temporary issues

            ## Recommended Actions

            1. Manually verify the live documents against the archive links
            2. If tampering is confirmed, the website will display a warning to visitors
            3. Consider capturing new archive snapshots of current state
            4. Update the verification data if this is a false positive

            ---
            *This issue was automatically created by the source verification workflow.*`,
                  labels: ['source-tampering', 'automated', 'urgent']
                });
              }
            }

      - name: Verification summary
        run: |
          echo "## Source Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify.outcome }}" == "success" ]; then
            echo "âœ… All primary sources verified successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some sources could not be verified. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Last run: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
